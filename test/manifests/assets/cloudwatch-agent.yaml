apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-cwagentconfig
  namespace: amazon-cloudwatch
data:
  cwagentconfig.json: |
    {
      "agent": {
        "debug": true,
        "region": "{{.REGION}}"
      },
      "logs": {
        "metrics_collected": {
          "prometheus": {
            "prometheus_config_path": "/etc/prometheusconfig/prometheus.yaml",
            "emf_processor": {
              "metric_declaration": [
                {
                  "source_labels": ["job"],
                  "label_matcher": "dcgm-exporter",
                  "dimensions": [["TestType", "KubernetesVersion", "Variant", "InstanceType", "TeamIdentifier"]],
                  "metric_selectors": [
                    "^DCGM_FI_DEV_GPU_UTIL$",
                    "^DCGM_FI_DEV_MEM_COPY_UTIL$",
                    "^DCGM_FI_DEV_FB_USED$",
                    "^DCGM_FI_DEV_FB_FREE$",
                    "^DCGM_FI_DEV_POWER_USAGE$"
                  ]
                }
              ]
            }
          }
        },
        "force_flush_interval": 5
      }
    }

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-config
  namespace: amazon-cloudwatch
data:
  prometheus.yaml: |
    global:
      scrape_interval: 1m
      scrape_timeout: 10s
    scrape_configs:
      - job_name: dcgm-exporter
        static_configs:
          - targets:
            - dcgm-exporter.kube-system.svc.cluster.local:9400
        metrics_path: /metrics
        scrape_interval: 30s
        metric_relabel_configs:
          - action: replace
            source_labels: [job]
            target_label: job
            replacement: "dcgm-exporter"
          - action: replace
            source_labels: [job]
            target_label: KubernetesVersion
            replacement: "{{.VERSION}}"
          - action: replace
            source_labels: [job]
            target_label: Variant
            replacement: "{{.VARIANT}}"
          - action: replace
            source_labels: [job]
            target_label: InstanceType
            replacement: "{{.INSTANCE_TYPE}}"
          - action: replace
            source_labels: [job]
            target_label: TeamIdentifier
            replacement: "{{.TEAM_IDENTIFIER}}"
          - action: replace
            source_labels: [job]
            target_label: TestType
            replacement: "{{.TEST_NAME}}"




---
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: cwagent-prometheus
  namespace: amazon-cloudwatch
spec:
  selector:
    matchLabels:
      app: cwagent-prometheus
  template:
    metadata:
      labels:
        app: cwagent-prometheus
    spec:
      serviceAccountName: cwagent-prometheus
      dnsPolicy: ClusterFirst 
      containers:
        - name: cloudwatch-agent
          image: public.ecr.aws/cloudwatch-agent/cloudwatch-agent:latest
          imagePullPolicy: Always
          env:
            - name: RUN_WITH_IRSA
              value: "True"
          resources:
            limits:
              cpu: 1000m
              memory: 1000Mi
            requests:
              cpu: 200m
              memory: 200Mi
          volumeMounts:
            - name: prometheus-cwagentconfig
              mountPath: /etc/cwagentconfig
            - name: prometheus-config
              mountPath: /etc/prometheusconfig
      volumes:
        - name: prometheus-cwagentconfig
          configMap:
            name: prometheus-cwagentconfig
        - name: prometheus-config
          configMap:
            name: prometheus-config
      terminationGracePeriodSeconds: 60
---