apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-cwagentconfig
  namespace: amazon-cloudwatch
data:
  cwagentconfig.json: |
    {
      "agent": {
        "debug": true
      },
      "logs": {
        "metrics_collected": {
          "prometheus": {
            "prometheus_config_path": "/etc/prometheusconfig/prometheus.yaml",
            "emf_processor": {
              "metric_declaration": [
                {
                  "source_labels": ["job"],
                  "label_matcher": "dcgm-exporter",
                  "dimensions": [[{{- if .MetricDimensions}}{{$first := true}}{{range $key, $value := .MetricDimensions}}{{if not $first}}, {{end}}"{{$key}}"{{$first = false}}{{end}}{{- end}}]],
                  "metric_selectors": [
                    "^DCGM_FI_DEV_GPU_UTIL$",
                    "^DCGM_FI_DEV_MEM_COPY_UTIL$",
                    "^DCGM_FI_DEV_FB_USED$",
                    "^DCGM_FI_DEV_FB_FREE$",
                    "^DCGM_FI_DEV_POWER_USAGE$"
                  ]
                }
              ]
            }
          }
        },
        "force_flush_interval": 5
      }
    }

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-config
  namespace: amazon-cloudwatch
data:
  prometheus.yaml: |
    global:
      scrape_interval: 1s
      scrape_timeout: 1s
    scrape_configs:
      - job_name: dcgm-exporter
        static_configs:
          - targets:
            - dcgm-exporter.kube-system.svc.cluster.local:9400
        metrics_path: /metrics
        metric_relabel_configs:
{{- if .MetricDimensions}}
{{- range $key, $value := .MetricDimensions}}
          - {action: replace, target_label: {{$key}}, replacement: '{{$value}}'}
{{- end}}
{{- end}}
---
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: cwagent
  namespace: amazon-cloudwatch
spec:
  selector:
    matchLabels:
      app: cwagent
  template:
    metadata:
      labels:
        app: cwagent
    spec:
      serviceAccountName: cwagent
      dnsPolicy: ClusterFirst 
      containers:
        - name: cloudwatch-agent
          image: public.ecr.aws/cloudwatch-agent/cloudwatch-agent:latest
          imagePullPolicy: Always
          resources:
            limits:
              cpu: 1000m
              memory: 1000Mi
            requests:
              cpu: 200m
              memory: 200Mi
          volumeMounts:
            - name: prometheus-cwagentconfig
              mountPath: /etc/cwagentconfig
            - name: prometheus-config
              mountPath: /etc/prometheusconfig
      volumes:
        - name: prometheus-cwagentconfig
          configMap:
            name: prometheus-cwagentconfig
        - name: prometheus-config
          configMap:
            name: prometheus-config
      terminationGracePeriodSeconds: 60
---